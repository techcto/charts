apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    k8s-app: oauth2-proxy
  name: oauth2-proxy
  namespace: kube-system
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: oauth2-proxy
  template:
    metadata:
      labels:
        k8s-app: oauth2-proxy
    spec:
      containers:
      - args:
        - --provider={{ .Values.provider.type }}
        - --provider-display-name={{ .Values.provider.display-name }}
        - --email-domain={{ .Values.provider.domain }}
        - --upstream=file:///dev/null
        - --http-address={{ .Values.provider.http-address }}
        - --client-id={{ .Values.provider.client-id }}
        - --client-secret={{ .Values.provider.client-secret }}
        - --redirect-url={{ .Values.provider.redirect-url }}
        - --oidc-issuer-url={{ .Values.provider.oidc-issuer-url }}
        - --skip-oidc-discovery
        - --login-url={{ .Values.provider.login-url }}
        - --redeem-url={{ .Values.provider.redeem-url }}
        - --oidc-jwks-url={{ .Values.provider.oidc-jwks-url }}
        - --cookie-secure={{ .Values.provider.cookie-secure }}
        image: quay.io/oauth2-proxy/oauth2-proxy:latest
        imagePullPolicy: Always
        name: oauth2-proxy
        ports:
        - containerPort: {{ .Values.provider.port }}
          protocol: TCP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    k8s-app: oauth2-proxy
  name: oauth2-proxy
  namespace: kube-system
spec:
  ports:
  - name: http
    port: {{ .Values.provider.port }}
    protocol: TCP
    targetPort: {{ .Values.provider.port }}
  selector:
    k8s-app: oauth2-proxy